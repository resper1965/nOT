# <!-- Powered by BMAD™ Core -->
workflow:
  id: network-vulnerability-analysis
  name: Network Vulnerability Analysis & Security Assessment
  description: >-
    Comprehensive workflow for analyzing network infrastructure, identifying vulnerabilities,
    detecting data leakage risks, and assessing security posture for OT/IT environments.
  type: security-assessment
  project_types:
    - vulnerability-assessment
    - security-audit
    - compliance-review
    - threat-modeling
    - penetration-testing-prep

  sequence:
    - step: project_scope_definition
      agent: network-security-analyst
      action: define security assessment scope
      notes: |
        Define assessment scope with stakeholders:
        - Network segments to analyze (OT, IT, DMZ, etc.)
        - Assets in scope (servers, workstations, SCADA, PLCs, etc.)
        - Assessment objectives (vulnerability scan, threat model, compliance, etc.)
        - Compliance requirements (LGPD, IEC 62443, NIST, ISO 27001, etc.)
        - Timeline and resource constraints
        
        Ask user: "Qual é o escopo da análise de segurança? 
        1. Avaliação completa de vulnerabilidades
        2. Análise de vazamento de dados
        3. Modelagem de ameaças
        4. Auditoria de conformidade
        5. Combinação de múltiplos objetivos"

    - step: topology_analysis
      agent: network-security-analyst
      action: analyze network topology
      uses: analyze-network-topology
      creates: network-topology-analysis.md
      notes: |
        Analyze network topology from available sources:
        - Parse JSON topology data (Topologia_TBE_full.json)
        - Identify network segments and boundaries
        - Map critical assets and data flows
        - Document trust zones and security boundaries
        - Identify single points of failure
        - Map external connections and internet exposure

    - step: asset_inventory
      agent: network-security-analyst
      action: create comprehensive asset inventory
      creates: asset-inventory.md
      requires: network-topology-analysis.md
      notes: |
        Build detailed asset inventory:
        - Categorize assets (servers, workstations, network devices, OT equipment)
        - Identify critical assets and crown jewels
        - Document operating systems and versions
        - Map services and open ports
        - Classify data sensitivity levels
        - Identify legacy/unsupported systems

    - step: threat_modeling
      agent: network-security-analyst
      action: create threat model
      uses: create-threat-model
      creates: threat-model.md
      requires: asset-inventory.md
      notes: |
        Develop comprehensive threat model:
        - Identify threat actors (external, insider, APT, etc.)
        - Map attack vectors and attack surface
        - Apply STRIDE or MITRE ATT&CK framework
        - Prioritize threats based on risk (likelihood x impact)
        - Document threat scenarios specific to OT environment
        - Consider supply chain and third-party risks

    - step: vulnerability_scanning
      agent: network-security-analyst
      action: perform vulnerability scan
      uses: scan-vulnerabilities
      creates: vulnerability-scan-results.md
      requires: asset-inventory.md
      notes: |
        Execute vulnerability assessment:
        - Scan for known CVEs and security misconfigurations
        - Check for outdated software and missing patches
        - Identify weak authentication mechanisms
        - Detect insecure protocols (Telnet, HTTP, FTP, etc.)
        - Analyze SSL/TLS configurations
        - Check for default credentials
        - Document exploitability and CVSS scores

    - step: data_leakage_analysis
      agent: network-security-analyst
      action: detect data leakage paths
      uses: detect-data-leakage
      creates: data-leakage-analysis.md
      requires: network-topology-analysis.md
      notes: |
        Analyze potential data exfiltration vectors:
        - Identify data flows crossing trust boundaries
        - Check for unencrypted data transmission
        - Analyze egress filtering and DLP controls
        - Identify removable media and USB access
        - Check cloud storage and email gateways
        - Assess insider threat vectors
        - Verify data classification and handling

    - step: access_control_review
      agent: network-security-analyst
      action: review access controls
      creates: access-control-review.md
      requires: asset-inventory.md
      notes: |
        Evaluate access control mechanisms:
        - Review authentication methods (passwords, MFA, certificates)
        - Assess authorization models (RBAC, ABAC)
        - Check privileged account management
        - Verify network segmentation and firewall rules
        - Review VPN and remote access controls
        - Assess wireless security (WPA2/WPA3)
        - Check for lateral movement opportunities

    - step: compliance_assessment
      agent: network-security-analyst
      action: assess regulatory compliance
      uses: assess-compliance
      creates: compliance-assessment.md
      condition: compliance_required
      notes: |
        Verify compliance with applicable standards:
        - LGPD (Lei Geral de Proteção de Dados)
        - IEC 62443 (Industrial Automation and Control Systems Security)
        - NIST Cybersecurity Framework
        - ISO/IEC 27001
        - CIS Controls
        - Industry-specific regulations
        Document gaps and remediation requirements

    - step: risk_prioritization
      agent: network-security-analyst
      action: prioritize security risks
      creates: risk-matrix.md
      requires: all_assessment_documents
      notes: |
        Create risk prioritization matrix:
        - Calculate risk scores (likelihood x impact)
        - Categorize risks (Critical, High, Medium, Low)
        - Consider business impact and criticality
        - Factor in exploitability and threat intelligence
        - Account for compensating controls
        - Create risk heat map

    - step: remediation_planning
      agent: network-security-analyst
      action: develop remediation plan
      creates: remediation-plan.md
      requires: risk-matrix.md
      notes: |
        Create actionable remediation roadmap:
        - Prioritize quick wins vs. long-term projects
        - Define remediation actions for each finding
        - Estimate effort and resource requirements
        - Create implementation timeline
        - Assign ownership and accountability
        - Define success metrics
        - Plan for validation testing

    - step: security_assessment_report
      agent: network-security-analyst
      action: compile comprehensive security report
      uses: create-security-assessment
      creates: security-assessment-report.md
      requires: all_documents
      notes: |
        Compile executive and technical reports:
        - Executive summary with key findings
        - Detailed technical findings
        - Risk prioritization and business impact
        - Remediation recommendations
        - Compliance status
        - Metrics and KPIs
        - Appendices with raw data
        SAVE OUTPUT: Copy to docs/security/ folder

    - step: workflow_end
      action: assessment_complete
      notes: |
        Security assessment complete!
        All findings documented and prioritized.
        Remediation plan ready for implementation.

  flow_diagram: |
    \`\`\`mermaid
    graph TD
        A[Start: Security Assessment] --> B[network-security-analyst: define scope]
        B --> C[analyze network topology]
        C --> D[create asset inventory]
        D --> E[develop threat model]
        E --> F[scan vulnerabilities]
        F --> G[analyze data leakage]
        G --> H[review access controls]
        
        H --> I{Compliance Required?}
        I -->|Yes| J[assess compliance]
        I -->|No| K[prioritize risks]
        J --> K
        
        K --> L[develop remediation plan]
        L --> M[compile security report]
        M --> N[Complete]
        
        style N fill:#90EE90
        style C fill:#FFE4B5
        style F fill:#FF6B6B
        style G fill:#FF6B6B
        style M fill:#87CEEB
        style L fill:#98D8C8

        classDef critical fill:#FF6B6B,stroke:#333,stroke-width:2px
        classDef important fill:#FFE4B5,stroke:#333,stroke-width:2px
        classDef standard fill:#87CEEB,stroke:#333,stroke-width:1px
    \`\`\`

  decision_guidance:
    when_to_use:
      - New network deployment requiring security validation
      - Existing network requiring security audit
      - Compliance assessment needed
      - Security incident response preparation
      - Post-incident security review
      - Pre-merger security due diligence
      - Regular security assessment cycle

    assessment_types:
      quick_scan:
        duration: 1-2 days
        scope: Automated vulnerability scanning + basic topology review
        use_when: Regular quarterly scans or change validation
      
      standard_assessment:
        duration: 1-2 weeks
        scope: Full vulnerability assessment + threat modeling + compliance
        use_when: Annual security audit or new deployment
      
      comprehensive_audit:
        duration: 3-4 weeks
        scope: All workflow steps including manual testing
        use_when: High-security environments, post-breach, compliance mandate

  handoff_prompts:
    scope_to_topology: |
      Escopo definido: {{assessment_type}}
      Segmentos de rede: {{network_segments}}
      Requisitos de conformidade: {{compliance_frameworks}}
      Iniciando análise de topologia...

    topology_to_inventory: |
      Análise de topologia concluída.
      {{device_count}} dispositivos identificados em {{segment_count}} segmentos.
      {{critical_assets_count}} ativos críticos mapeados.
      Criando inventário detalhado de ativos...

    assessment_complete: |
      Avaliação de segurança concluída!
      
      Resumo executivo:
      - Risco geral: {{overall_risk_level}}
      - Vulnerabilidades críticas: {{critical_count}}
      - Prioridades de remediação: {{top_priorities}}
      - Status de conformidade: {{compliance_status}}
      
      Relatório completo salvo em: docs/security/
      Plano de remediação disponível para implementação.
